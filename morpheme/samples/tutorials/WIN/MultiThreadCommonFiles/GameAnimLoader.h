// Copyright (c) 2010 NaturalMotion.  All Rights Reserved.
// Not to be copied, adapted, modified, used, distributed, sold,
// licensed or commercially exploited in any manner without the
// written consent of NaturalMotion.
//
// All non public elements of this software are the confidential
// information of NaturalMotion and may not be disclosed to any
// person nor used for any purpose not expressly approved by
// NaturalMotion in writing.

//----------------------------------------------------------------------------------------------------------------------
#ifdef _MSC_VER
  #pragma once
#endif
#ifndef GAME_ANIM_LOADER_H
#define GAME_ANIM_LOADER_H
//----------------------------------------------------------------------------------------------------------------------
#include "comms/connection.h"
#include "morpheme/AnimSource/mrAnimSource.h"
#include "simpleBundle/simpleAnimRuntimeIDtoFilenameLookup.h"
//----------------------------------------------------------------------------------------------------------------------

//----------------------------------------------------------------------------------------------------------------------
/// \class GameAnimLoader
/// \brief This is an example implementation of an animation loader that handles animation (un)loading from disk.
///
/// GameAnimModule registers this animation loader with MR::Manager for use with the tutorials. As this class has little
/// outside dependencies it should serve well as a starting point for your own implementations.
///
/// The functions in this class are designed to work with the bundles generated by the default morpheme asset compilers.
/// These bundles contain an asset of type kAsset_SimpleAnimRuntimeIDtoFilenameLookup which is used to translate the
/// animation asset IDs provided by the morpheme runtime into filenames. The filenames are in turn used to load and
/// unpack the respective files into memory and return the located memory to the morpheme runtime.
///
/// Further, the assumption is made that all animation files are located in a folder ANIM_ROOT_FOLDER (or loaded over a
/// COMMS connection if set in the user data). The memory is allocated/freed using the functions provided by
/// NMP::Memory and animations are not shared between network definitions (see MR::UTILS::SimpleAnimRegistry for how to
/// share animations between definitions).
//----------------------------------------------------------------------------------------------------------------------
class GameAnimLoader
{
public:

  class UserData
  {
  public:

    MR::UTILS::SimpleAnimRuntimeIDtoFilenameLookup*   m_animFileLookup;
    MCOMMS::Connection*                               m_connection;

    UserData() : m_animFileLookup(NULL), m_connection(NULL) {}
  };

  static const char ANIM_ROOT_FOLDER[];

  /// \brief This function is registered with morpheme to handle animation loading.
  /// \see MR::Manager::setAnimFileHandlingFunctions()
  /// \see MR::Manager::RequestAnimFn
  ///
  /// Depending on the user data provided, animations are either loaded from disk or over the provided COMMS connection.
  /// The general use case is to load animations from disk while loading over a connection is required only if the
  /// network preview capability is supported (see the LiveLinkNetworkPreview tutorial).
  static MR::AnimSourceBase* requestAnim(const MR::RuntimeAnimAssetID animAssetID, void* userdata);

  /// \brief This function is registered with morpheme to handle animation unloading.
  /// \see MR::Manager::setAnimFileHandlingFunctions()
  /// \see MR::Manager::ReleaseAnimFn
  static void releaseAnim(const MR::RuntimeAnimAssetID animAssetID, MR::AnimSourceBase* loadedAnimation, void* userdata);

private:

  /// GameAnimLoader is a static class.
  GameAnimLoader() {}
};

//----------------------------------------------------------------------------------------------------------------------
#endif // GAME_ANIM_LOADER_H
//----------------------------------------------------------------------------------------------------------------------
